<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Relatórios METAR/SPECI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --primary-color: #0f172a;
            --primary-light: #1e293b;
            --secondary-color: #3b82f6;
            --accent-color: #06b6d4;
            --background-color: #f8fafc;
            --background-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --text-color: #1e293b;
            --text-muted: #64748b;
            --alert-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --box-shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            line-height: 1.6; 
            color: var(--text-color); 
            background: var(--background-gradient);
            padding: 24px;
            min-height: 100vh;
        }
        
        header { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white; padding: 32px; border-radius: var(--border-radius); 
            margin-bottom: 32px; text-align: center; box-shadow: var(--box-shadow-lg);
            position: relative; overflow: hidden;
        }
        
        header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            pointer-events: none;
        }
        
        header h1 { font-size: 2.5rem; font-weight: 700; }
        
        .historical-search-container { max-width: 1400px; margin: 0 auto; }
        
        .card { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-radius: var(--border-radius); padding: 24px; box-shadow: var(--box-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2); transition: var(--transition);
        }
        
        .card:hover { transform: translateY(-2px); box-shadow: var(--box-shadow-lg); }
        
        .historical-search { margin-top: 32px; }
        .search-controls { display: flex; flex-wrap: wrap; gap: 24px; align-items: center; }
        .search-controls input[type="text"], .search-controls input[type="date"], .search-controls input[type="month"] { padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); border-radius: var(--border-radius-sm); font-size: 1rem; }
        .search-controls button { padding: 10px 20px; font-size: 1rem; background: var(--primary-color); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; transition: var(--transition); }
        .search-controls button:hover { background: var(--primary-light); }
        .search-controls button:disabled { background: var(--text-muted); cursor: not-allowed; }
        #historicalSearchStatus { margin-top: 16px; font-weight: 500; }
        .search-type-selector, .search-filter { margin-bottom: 16px; display: flex; gap: 16px; align-items: center; font-weight: 500;}
        .hidden { display: none; }

        footer { margin-top: 48px; text-align: center; color: var(--text-muted); }
    </style>
</head>
<body>
    <header>
        <h1>Admin - Busca de Relatórios METAR/SPECI</h1>
    </header>

    <div class="historical-search-container">
        <div class="card historical-search">
            <h3>Busca Histórica e Relatórios</h3>
            
            <div class="search-type-selector">
                <strong>Tipo de Busca:</strong>
                <label><input type="radio" name="searchType" value="daily" id="radioDiario" checked> Diário</label>
                <label><input type="radio" name="searchType" value="monthly" id="radioMensal"> Mensal</label>
            </div>

             <div class="search-filter">
                <label><input type="checkbox" id="filterInconsistent"> Gerar somente com mensagens inconsistentes</label>
            </div>

            <div class="search-controls">
                <label for="historicalAerodromoInput">Código ICAO:</label>
                <input type="text" id="historicalAerodromoInput" maxlength="4" style="text-transform: uppercase; width: 100px;">
                
                <div id="dailyInputContainer">
                    <label for="historicalDateInput">Data:</label>
                    <input type="date" id="historicalDateInput">
                </div>
                
                <div id="monthlyInputContainer" class="hidden">
                    <label for="historicalMonthInput">Mês/Ano:</label>
                    <input type="month" id="historicalMonthInput">
                </div>
                
                <button id="generateHistoricalReportBtn">Gerar Relatório</button>
            </div>
            <p id="historicalSearchStatus"></p>
        </div>
    </div>

    <footer>
        <p>Sistema de Geração de Relatórios METAR/SPECI</p>
    </footer>
    
    <script>
        const CONFIG = {
            // Aponta para a nova API criada para este sistema, que lida com buscas históricas.
            apiUrl: '/api/metaradm' 
        };

        const elements = {
            historicalAerodromoInput: document.getElementById('historicalAerodromoInput'),
            historicalDateInput: document.getElementById('historicalDateInput'),
            historicalMonthInput: document.getElementById('historicalMonthInput'),
            generateHistoricalReportBtn: document.getElementById('generateHistoricalReportBtn'),
            historicalSearchStatus: document.getElementById('historicalSearchStatus'),
            radioDiario: document.getElementById('radioDiario'),
            radioMensal: document.getElementById('radioMensal'),
            dailyInputContainer: document.getElementById('dailyInputContainer'),
            monthlyInputContainer: document.getElementById('monthlyInputContainer'),
            filterInconsistent: document.getElementById('filterInconsistent')
        };

        document.addEventListener('DOMContentLoaded', inicializarApp);

        function inicializarApp() {
            elements.historicalAerodromoInput.value = 'SBIZ'; // Aeródromo padrão
            elements.historicalDateInput.valueAsDate = new Date();
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            elements.historicalMonthInput.value = `${year}-${month}`;
            
            elements.radioDiario.addEventListener('change', toggleSearchType);
            elements.radioMensal.addEventListener('change', toggleSearchType);
            elements.generateHistoricalReportBtn.addEventListener('click', iniciarBuscaHistorica);
        }
        
        function toggleSearchType() {
            if (elements.radioDiario.checked) {
                elements.dailyInputContainer.classList.remove('hidden');
                elements.monthlyInputContainer.classList.add('hidden');
            } else {
                elements.dailyInputContainer.classList.add('hidden');
                elements.monthlyInputContainer.classList.remove('hidden');
            }
        }
        
        function iniciarBuscaHistorica() {
            if (elements.radioDiario.checked) {
                buscarHistoricoDiarioEGerarPDF();
            } else {
                buscarHistoricoMensalEGerarPDF();
            }
        }

        async function buscarHistoricoDiarioEGerarPDF() {
            const icao = elements.historicalAerodromoInput.value.trim().toUpperCase();
            const date = elements.historicalDateInput.value;
            const statusEl = elements.historicalSearchStatus;
            const buttonEl = elements.generateHistoricalReportBtn;

            if (!/^[A-Z]{4}$/.test(icao) || !date) {
                statusEl.textContent = 'Erro: Verifique o ICAO e a data selecionada.';
                statusEl.style.color = 'var(--alert-color)';
                return;
            }
            
            buttonEl.disabled = true;
            statusEl.textContent = 'Buscando dados...';
            statusEl.style.color = 'var(--text-muted)';
            
            const data_ini = date.replace(/-/g, '') + '00';
            const data_fim = date.replace(/-/g, '') + '23';

            const url = `${CONFIG.apiUrl}?localidade=${icao}&data_ini=${data_ini}&data_fim=${data_fim}`;

            try {
                const response = await fetch(url, { cache: 'no-store' });
                const data = await response.json();
                
                if (!response.ok) throw new Error(`Erro: ${data.message || response.statusText}`);
                if (!data.status && data.message && !data.message.includes("data inicial ou final")) throw new Error(data.message);

                let dadosParaRelatorio = (data.data && data.data.data && data.data.data.length > 0) ? data.data.data : [];

                if (elements.filterInconsistent.checked) {
                    dadosParaRelatorio = dadosParaRelatorio.filter(msg => isMessageInconsistent(msg));
                }
                
                if (dadosParaRelatorio.length > 0) {
                    statusEl.textContent = `Encontradas ${dadosParaRelatorio.length} mensagens. Gerando PDF...`;
                    statusEl.style.color = 'var(--success-color)';
                    gerarPDFHistorico(dadosParaRelatorio, icao, date, 'daily');
                } else {
                    const dataFormatada = new Date(date.replace(/-/g, '/')).toLocaleDateString();
                    const msgText = elements.filterInconsistent.checked 
                        ? `Nenhuma mensagem inconsistente encontrada para ${icao} na data ${dataFormatada}.`
                        : `Nenhuma mensagem encontrada para ${icao} na data ${dataFormatada}.`;
                    statusEl.textContent = msgText;
                    statusEl.style.color = 'var(--warning-color)';
                }
            } catch (error) {
                console.error("Erro na busca diária:", error);
                statusEl.textContent = `Erro ao buscar dados: ${error.message}`;
                statusEl.style.color = 'var(--alert-color)';
            } finally {
                buttonEl.disabled = false;
            }
        }
        
        async function buscarHistoricoMensalEGerarPDF() {
            const icao = elements.historicalAerodromoInput.value.trim().toUpperCase();
            const monthValue = elements.historicalMonthInput.value;
            const statusEl = elements.historicalSearchStatus;
            const buttonEl = elements.generateHistoricalReportBtn;

            if (!/^[A-Z]{4}$/.test(icao) || !monthValue) {
                statusEl.textContent = 'Erro: Verifique o ICAO e o Mês/Ano selecionado.';
                statusEl.style.color = 'var(--alert-color)';
                return;
            }
            
            buttonEl.disabled = true;
            buttonEl.textContent = 'Buscando...';

            const [year, month] = monthValue.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            let todasAsMensagens = [];

            try {
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayString = day.toString().padStart(2, '0');
                    const monthString = month.toString().padStart(2, '0');
                    const dateString = `${year}${monthString}${dayString}`;
                    
                    statusEl.textContent = `Buscando dados para o dia ${day} de ${daysInMonth}...`;
                    statusEl.style.color = 'var(--text-muted)';

                    const data_ini = dateString + '00';
                    const data_fim = dateString + '23';
                    
                    const url = `${CONFIG.apiUrl}?localidade=${icao}&data_ini=${data_ini}&data_fim=${data_fim}`;

                    const response = await fetch(url, { cache: 'no-store' });
                    const data = await response.json();
                    
                    if (data.status && data.data && data.data.data && data.data.data.length > 0) {
                        todasAsMensagens.push(...data.data.data);
                    }
                    // Adiciona uma pequena pausa para não sobrecarregar a API
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                let dadosParaRelatorio = todasAsMensagens;
                if (elements.filterInconsistent.checked) {
                    dadosParaRelatorio = dadosParaRelatorio.filter(msg => isMessageInconsistent(msg));
                }

                if (dadosParaRelatorio.length > 0) {
                    statusEl.textContent = `Total de ${dadosParaRelatorio.length} mensagens encontradas. Gerando PDF...`;
                    statusEl.style.color = 'var(--success-color)';
                    gerarPDFHistorico(dadosParaRelatorio, icao, monthValue, 'monthly');
                } else {
                    const monthName = new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                    const msgText = elements.filterInconsistent.checked
                        ? `Nenhuma mensagem inconsistente encontrada para ${icao} em ${monthName} de ${year}.`
                        : `Nenhuma mensagem encontrada para ${icao} em ${monthName} de ${year}.`;
                    statusEl.textContent = msgText;
                    statusEl.style.color = 'var(--warning-color)';
                }

            } catch (error) {
                console.error("Erro na busca mensal:", error);
                statusEl.textContent = `Erro ao buscar dados: ${error.message}`;
                statusEl.style.color = 'var(--alert-color)';
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = 'Gerar Relatório';
            }
        }
        
        function isMessageInconsistent(msgObject) {
            const mensText = msgObject.mens || '';
            const recepcaoInfo = msgObject.timestamp || msgObject.recebimento;
            if (!mensText || !recepcaoInfo) return false;

            const recepcaoDate = new Date((typeof recepcaoInfo === 'string' ? recepcaoInfo.replace(' ', 'T') + 'Z' : recepcaoInfo));
            if (isNaN(recepcaoDate.getTime())) return false;

            const tipo = mensText.trim().startsWith('SPECI') ? 'SPECI' : 'METAR';
            const regex = /\s(\d{2})(\d{2})(\d{2})Z\s/;
            const match = mensText.match(regex);
            
            if (!match) return false;

            const msgDay = parseInt(match[1], 10);
            const msgHour = parseInt(match[2], 10);
            const msgMinute = parseInt(match[3], 10);
            
            const msgDate = new Date(Date.UTC(recepcaoDate.getUTCFullYear(), recepcaoDate.getUTCMonth(), msgDay, msgHour, msgMinute));
            
            if (isNaN(msgDate.getTime())) return false;
            
            const diffEmMinutos = (recepcaoDate.getTime() - msgDate.getTime()) / (1000 * 60);

            const threshold = (tipo === 'METAR') ? 5 : 15;

            return diffEmMinutos > threshold;
        }

        function gerarPDFHistorico(mensagens, icao, dateValue, type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let title, filename;
            const isFiltered = elements.filterInconsistent.checked;

            if (type === 'daily') {
                const dataFormatada = new Date(dateValue.replace(/-/g, '/')).toLocaleDateString('pt-BR');
                title = isFiltered ? `Relatório de Inconsistências - ${icao} - ${dataFormatada}` : `Relatório Diário - ${icao} - ${dataFormatada}`;
                filename = `relatorio_${isFiltered ? 'inconsistencias' : 'diario'}_${icao}_${dateValue}.pdf`;
            } else { // monthly
                const [year, month] = dateValue.split('-');
                const monthName = new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                const formattedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                title = isFiltered ? `Relatório de Inconsistências - ${icao} - ${formattedMonth} de ${year}` : `Relatório Mensal - ${icao} - ${formattedMonth} de ${year}`;
                filename = `relatorio_${isFiltered ? 'inconsistencias' : 'mensal'}_${icao}_${dateValue}.pdf`;
            }
            
            doc.text(title, 14, 15);
            
            const tableColumn = ["Tipo", "Hora UTC Msg", "Data Recebimento", "Hora Recebimento"];
            
            const dadosFormatados = mensagens.map(msg => {
                const tipo = msg.mens.trim().startsWith('SPECI') ? 'SPECI' : 'METAR';
                const regex = /\s(\d{2})(\d{2})(\d{2})Z\s/;
                const match = msg.mens.match(regex);
                let horaUTC = "N/A";
                if (match) {
                    horaUTC = `${match[2]}${match[3]}Z`;
                }
                return { mens: msg.mens, recebimento: msg.recebimento, tipo: tipo, timestamp: new Date(msg.recebimento), horaUTC: horaUTC };
            }).sort((a,b) => a.timestamp - b.timestamp);

            const tableRows = dadosFormatados.map(d => [d.tipo, d.horaUTC, d.timestamp.toLocaleDateString('pt-BR'), d.timestamp.toLocaleTimeString('pt-BR')]);
            
            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 20,
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        const originalData = dadosFormatados[data.row.index];
                        if (isMessageInconsistent(originalData)) {
                             data.cell.styles.textColor = [239, 68, 68];
                        }
                    }
                }
            });
            
            doc.save(filename);
            elements.historicalSearchStatus.textContent = `Relatório gerado com sucesso!`;
        }

    </script>
</body>
</html>
